# 🌦️ Backend Agent Connection Guide

こんにちは！このガイドでは、AI畑おじさんアプリのバックエンドから、Google Cloud の AI エージェント（Agent Engine）に接続するための手順をわかりやすく解説します。

このディレクトリには、AI エージェントと会話をするためのプログラムが含まれています。これを使うと、「東京の天気は？」といった質問を AI に送って、回答をもらうことができます。

---

## 📋 目次

1. [全体の仕組み](#1-全体の仕組み)
2. [準備すること（前提条件）](#2-準備すること前提条件)
3. [セットアップ手順](#3-セットアップ手順)
4. [使い方](#4-使い方)
5. [困ったときは（トラブルシューティング）](#5-困ったときはトラブルシューティング)

---

## 1. 全体の仕組み

このアプリは、**Google Cloud Vertex AI Agent Engine** というサービス上に作られた「天気予報エージェント」と連携します。

- **`agent.py`**: エージェントと会話するための「電話機」のようなプログラムです。
- **`manifest` (Cloud Run)**: このアプリを動かす場所です。

仕組みとしては、以下のようになります：
1. アプリ（Cloud Run）からエージェントに「もしもし（セッション作成）」と連絡します。
2. アプリが「東京の天気は？」と質問（クエリ送信）します。
3. エージェントが考えて「晴れです」と答えます。

---

## 2. 準備すること（前提条件）

アプリを動かす前に、以下の2つの設定が必要です。

### ① 権限の設定 (Permisssions)

AI エージェントとお話しするには、許可証（権限）が必要です。
**`Vertex AI ユーザー (roles/aiplatform.user)`** という権限を、アプリを動かすアカウントに持たせてください。

- **Cloud Run で動かす場合**:
  Cloud Run に設定されている「サービスアカウント」に、この権限を追加します。
- **自分のパソコン（ローカル）で試す場合**:
  `gcloud auth login` でログインしている自分のアカウントに、この権限があるか確認してください。

### ② 接続先の設定 (Environment Variable)

「どこにいるエージェントに電話するか」を教えるために、**環境変数** を設定する必要があります。

| 変数名 | 設定する値 | 説明 |
|---|---|---|
| `AGENT_ENDPOINT` | エージェントのリソース名 | エージェントの「住所」のようなものです。 |

**リソース名の例**:
`projects/123456789/locations/us-central1/reasoningEngines/987654321`

※ この値は、エージェントをデプロイしたとき（`adk deploy` コマンドを実行したあと）に画面に表示されます。忘れてしまった場合は、Google Cloud コンソールの Vertex AI の画面でも確認できます。

---

## 3. セットアップ手順

必要なライブラリをインストールします。（通常はアプリ全体のインストール時に自動で行われます）

```bash
pip install -r requirements.txt
```

`requirements.txt` には、Googleへの接続に必要な `google-auth` や `requests` が書かれています。

---

## 4. 使い方

### ✅ 動作確認

`get_weather` API を呼び出すか、以下のようにコードから利用して確認できます。

1. **ターミナルを開く**
2. **環境変数をセットする**
   （`projects/...` の部分は、あなたのエージェントのリソース名に書き換えてください！）
   ```bash
   export AGENT_ENDPOINT="projects/あなたのプロジェクトID/locations/us-central1/reasoningEngines/エージェントID"
   ```

---

## 5. 困ったときは（トラブルシューティング）

### 😱 `403 Forbidden` エラーが出る
権限が足りていません。「準備すること」の ① を確認し、**Vertex AI ユーザー** の権限が付与されているかチェックしてください。

### 😱 `404 Not Found` エラーが出る
接続先が見つかりません。`AGENT_ENDPOINT` の値が間違っている可能性があります。
- プロジェクトIDやロケーション（`us-central1`など）が合っているか
- そもそもエージェントがデプロイされているか
を確認してください。

### 😱 `ValueError: AGENT_ENDPOINT environment variable is not set`
環境変数が設定されていません。「使い方」のステップ2を見て、`export AGENT_ENDPOINT=...` を実行してからアプリを起動してください。

---
うまく動かない場合は、エラーメッセージをコピーして開発者に相談してください！ 🥬
