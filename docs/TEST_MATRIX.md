# テスト仕様書（テストマトリクス）

## 概要

このドキュメントは、バックエンド（Python/pytest）およびフロントエンド（TypeScript/Jest）の実装済みテストケースの一覧を記載しています。

- **バックエンド**: 473テスト / 96% カバレッジ
- **フロントエンド**: 42テスト / 6スイート
- **総合**: 515テスト / 100% パス率

## バックエンド（Python/pytest）テスト

### 1. APIエンドポイント（main.py） — 131テスト

main.py の全エンドポイント、ミドルウェア、バックグラウンドタスク、ヘルパー関数をカバー。

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| 天気API | 2 | 成功・エラーハンドリング |
| センサーAPI | 5 | latest成功/データなし、history成功/エラー、追加エラー |
| 野菜API | 4 | latest成功/データなし、リスト、追加エラー |
| 種登録API | 3 | 成功、エラー、JSONパースエラー |
| 種ガイドジョブ | 6 | 作成、ステータス取得、画像プロキシ、GCSプロキシ |
| エージェントログ | 2 | 成功・エラー |
| 日記API | 14 | リスト、取得、画像、自動生成(認証含む)、サービス不可 |
| プラントカメラ | 4 | 成功、画像なし、追加テスト |
| GCSヘルパー | 3 | URLバリデーション、ダウンロード成功/エラー |
| キャラクターAPI | 14 | ジョブ作成/ステータス、一覧、選択、取得、画像プロキシ |
| 種ガイド保存 | 11 | 保存、一覧、取得、削除、画像ハイドレート |
| 統合ランナー | 6 | ジョブ開始・ステータス、内部ロジック |
| バックグラウンドタスク | 12 | process_seed_guide、process_character_generation、エッジケース |
| ミドルウェア | 2 | ロギング、例外処理 |
| SSE/手動日記 | 5 | SSEストリーミング、タイムアウトping、外部例外 |
| 起動イベント | 2 | startup_event ログ検証 |
| ヘルパー | 5 | make_serializable、progress_wrapper、野菜選択/削除 |

### 2. データベース機能（db.py） — 75テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| 野菜ステータス初期化 | 3 | 成功、DB未接続、DBエラー |
| 野菜ステータス更新 | 4 | データあり/なし、DB未接続、エラー |
| 野菜データ取得 | 5 | 全件取得、最新取得、エラーケース |
| エージェント実行ログ | 3 | 成功、DB未接続、エラー |
| Firestore初期化 | 2 | 正常初期化、例外ハンドリング |
| 育成指示保存 | 3 | 成功、DB未接続、エラー |
| エッジエージェント設定 | 10 | 更新（4パターン）、取得（4パターン）、選択 |
| 野菜指示選択 | 6 | 成功、DB未接続、例外、未存在 |
| センサーログ | 6 | 最新取得、履歴取得（各3パターン） |
| 種ガイド保存 | 18 | 保存/更新/一覧/取得/ステータス更新 |
| キャラクタージョブ | 10 | 一覧、選択、取得 |
| 既存ドキュメント更新 | 2 | 結果なしドキュメント |

### 3. 日記サービス（diary_service.py） — 71テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| 統計計算 | 3 | 正常、空データ、エッジケース |
| キーイベント抽出 | 7 | 正常、空、追加パターン |
| 日記レスポンス解析 | 4 | JSON、マークダウン、追加 |
| プロンプト構築 | 6 | 標準、キャラクター付き（4パターン） |
| データベース操作 | 10 | 保存、一覧、取得、ステータス |
| データ収集（同期） | 2 | 成功、コールバック付き |
| 認証ヘッダー | 2 | ADC、APIキー |
| リトライリクエスト | 4 | 成功、リトライ、エラー |
| 非同期データ収集 | 15 | ログ/センサー/野菜/画像の各非同期取得 |
| AI日記生成 | 4 | 成功、エラー各パターン |
| 日記ステータス管理 | 6 | 初期化、失敗マーク |
| 日記処理フロー | 6 | process_daily_diary 成功/エラー/同期コールバック |
| キャラクター選択 | 4 | 成功、未設定、エラー |
| HTTPリトライ | 1 | RequestError ハンドリング |

### 4. 種画像解析サービス（seed_service.py） — 38テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| 種解析ガイド生成 | 5 | 成功、APIキーなし、エラー、コールバック、失敗 |
| アクセストークン取得 | 1 | ADC認証 |
| APIバックオフ呼び出し | 6 | 成功、リトライ、エラー各パターン |
| ステップ処理 | 9 | 成功、画像あり/なし、エラー、追加パターン |
| 並列画像生成 | 1 | 並列実行テスト |
| 単一ガイド画像生成 | 8 | 成功、non-200、フォールバック、追加パターン |
| 画像抽出 | 3 | 正常、空レスポンス |
| 解析モード | 5 | per-stepモード、singleモード（画像なし含む） |

### 5. 種袋解析・Deep Research（research_agent.py） — 37テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| 認証ヘッダー | 3 | ADC成功、APIキー、ADC失敗 |
| リクエストリトライ | 8 | 成功、429リトライ、5xxリトライ、例外パス |
| 種袋解析 | 4 | 成功、エラー、パースエラー、レスポンス解析 |
| 構造化データ抽出 | 7 | 成功、空テキスト、エラー、追加パターン |
| WebGrounding | 11 | 成功、完了済み、エラー、追加パターン |
| Deep Research | 11 | 成功、失敗、タイムアウト、追加パターン |

### 6. ロガー（logger.py） — 34テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| セッション管理 | 6 | 開始/終了、オーバーラップ、リセット |
| ロガー設定 | 4 | セットアップ、JSONブランチ |
| ログ関数 | 5 | info/warning/error/debug |
| セッション追跡 | 2 | 自動セッション、コンテキスト付き |
| StructuredFormatter | 4 | フォーマット出力（各パターン） |
| コンテキスト付きログ | 4 | 追加情報、例外 |
| クリティカル関数 | 2 | ログ出力、レベル確認 |
| デコレーター（同期） | 4 | 成功、例外、リターン値 |
| デコレーター（非同期） | 4 | 成功、例外、リターン値 |

### 7. 画像サービス（image_service.py） — 27テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| ストレージクライアント | 1 | 正常取得 |
| 絵日記生成 | 12 | 成功、キャラクター付き、キーなし、画像なし、エラー |
| APIバックオフ呼び出し | 8 | 成功、リトライ、各種エラーパターン |
| キャラクター解決 | 5 | DB取得、GCS取得、エラーケース |
| レスポンス解析 | 1 | non-200 primary |
| 外部例外 | 1 | 最上位例外ハンドリング |

### 8. エージェント機能（agent.py） — 24テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| 認証ヘッダー | 1 | ADC取得 |
| エージェント位置/ID | 3 | 成功、未設定、不正フォーマット |
| セッション作成 | 3 | 即時、LRO、HTTPエラー |
| セッションクエリ | 10 | 成功、空、エッジケース（空SSE、非JSONエラー等） |
| LRO待機 | 4 | 成功、タイムアウト、エラー |
| 天気取得 | 2 | 成功、エラー |
| Cloud Logging | 1 | セットアップ確認 |

### 9. キャラクター生成サービス（character_service.py） — 10テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| キャラクター解析・生成 | 9 | 成功（3回リトライ内）、キーなし、エラー、生成失敗 |
| 非リトライエラー | 1 | 400系エラー即時終了 |

### 10. 指示選択機能（test_select_feature.py） — 5テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| DB指示選択 | 3 | 成功、未存在、DB未接続 |
| エンドポイント | 2 | 成功、エラー |

### 11. 種ガイド永続化（test_seed_guide_persistence.py） — 4テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| 保存・一覧・取得 | 4 | 各CRUD操作 |

### 12. キャラクターAPI（test_character_api.py） — 4テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| ジョブ作成/ステータス | 2 | 成功 |
| メタデータ/画像プロキシ | 2 | 成功 |

### 13. 野菜設定（test_vegetable_config.py） — 4テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| エッジエージェント設定 | 2 | 更新、取得 |
| 日記生成優先順位 | 2 | 設定優先、フォールバック |

### 14. ユーティリティ（test_utils.py） — 4テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| 基本操作 | 4 | pytest確認、アサーション、文字列、リスト |

### 15. 非同期フロー（test_async_flow.py） — 3テスト

| カテゴリ | テスト数 | 概要 |
| :--- | ---: | :--- |
| 非同期生成フロー | 3 | ジョブ作成、ステータス遷移、エラー |

---

## フロントエンド（TypeScript/Jest）テスト — 42テスト

### 1. ユーティリティ関数（lib/utils.ts） — 7テスト

| ID | テストケース概要 | 区分 |
|----|------------------|------|
| FE-UTIL-001 | クラス名マージ | 正常系 |
| FE-UTIL-002 | 条件付きクラス処理 | 正常系 |
| FE-UTIL-003 | undefined/null処理 | 正常系 |
| FE-UTIL-004 | Tailwindクラスマージ | 正常系 |
| FE-UTIL-005 | 空入力処理 | 正常系 |
| FE-UTIL-006 | 配列入力処理 | 正常系 |
| FE-UTIL-007 | オブジェクト条件付きクラス | 正常系 |

### 2. MetricCardコンポーネント — 5テスト

| ID | テストケース概要 | 区分 |
|----|------------------|------|
| FE-COMP-001 | 基本プロパティでレンダリング | 正常系 |
| FE-COMP-002 | デフォルトステータス（normal） | 正常系 |
| FE-COMP-003 | warningステータス | 正常系 |
| FE-COMP-004 | criticalステータス | 正常系 |
| FE-COMP-005 | アイコン表示 | 正常系 |

### 3. WeatherCardコンポーネント — 9テスト

| ID | テストケース概要 | 区分 |
|----|------------------|------|
| FE-COMP-006 | タイトル表示 | 正常系 |
| FE-COMP-007 | 現在の気温表示 | 正常系 |
| FE-COMP-008 | 天気説明表示 | 正常系 |
| FE-COMP-009 | 風速表示 | 正常系 |
| FE-COMP-010 | 日の出時刻表示 | 正常系 |
| FE-COMP-011 | 日の入時刻表示 | 正常系 |
| FE-COMP-012 | 時間別予報時刻 | 正常系 |
| FE-COMP-013 | 時間別予報気温 | 正常系 |
| FE-COMP-014 | 複数アイコン表示 | 正常系 |

### 4. GrowthStageCardコンポーネント — 9テスト

| ID | テストケース概要 | 区分 |
|----|------------------|------|
| FE-COMP-015 | タイトル表示 | 正常系 |
| FE-COMP-016 | 現在の段階表示 | 正常系 |
| FE-COMP-017 | 播種日数表示 | 正常系 |
| FE-COMP-018 | 進捗率表示 | 正常系 |
| FE-COMP-019 | 進捗ラベル表示 | 正常系 |
| FE-COMP-020 | 全段階略称表示 | 正常系 |
| FE-COMP-021 | プログレスバー表示 | 正常系 |
| FE-COMP-022 | タイムラインドット表示 | 正常系 |
| FE-COMP-023 | アイコン表示 | 正常系 |

### 5. PlantCameraコンポーネント — 6テスト

| ID | テストケース概要 | 区分 |
|----|------------------|------|
| FE-COMP-024 | ローディング状態表示 | 正常系 |
| FE-COMP-025 | タイトルとバッジ表示 | 正常系 |
| FE-COMP-026 | 画像取得成功 | 正常系 |
| FE-COMP-027 | 画像なし時エラー表示 | 異常系 |
| FE-COMP-028 | ネットワークエラー時 | 異常系 |
| FE-COMP-029 | レスポンスエラー時 | 異常系 |

### 6. EnvironmentChartコンポーネント — 6テスト

| ID | テストケース概要 | 区分 |
|----|------------------|------|
| FE-COMP-030 | タイトル表示 | 正常系 |
| FE-COMP-031 | 期間セレクター表示 | 正常系 |
| FE-COMP-032 | マウント時データ取得 | 正常系 |
| FE-COMP-033 | 空データ時表示 | 正常系 |
| FE-COMP-034 | ネットワークエラー時 | 異常系 |
| FE-COMP-035 | アイコン表示 | 正常系 |

---

## テスト実行方法

### バックエンド
```bash
cd backend
pip install -r requirements.txt
pytest
```

### カバレッジ付きバックエンド
```bash
cd /path/to/project
venv/bin/python -m pytest backend/tests/ --cov=backend --cov-config=backend/pytest.ini --cov-report=term-missing
```

### フロントエンド
```bash
cd frontend
npm install --legacy-peer-deps
npm test
```

---

## テストカバレッジ

### バックエンド（96%）

| ファイル | Stmts | Miss | Cover |
| :--- | ---: | ---: | ---: |
| agent.py | 131 | 5 | 96% |
| character_service.py | 71 | 2 | 97% |
| db.py | 322 | 9 | 97% |
| diary_service.py | 290 | 9 | 97% |
| image_service.py | 157 | 4 | 97% |
| logger.py | 115 | 0 | 100% |
| main.py | 976 | 57 | 94% |
| research_agent.py | 190 | 2 | 99% |
| seed_service.py | 261 | 9 | 97% |
| **合計** | **2513** | **97** | **96%** |

> 未カバーの約97行はインポートフォールバック（`except ImportError`）、デッドコード（重複エンドポイント）、`if __name__ == "__main__"` ガード等の構造的にカバー困難なコードです。

### フロントエンド
- テストスイート: 6件 すべてパス
- テスト数: 42件 すべてパス

---

## 総合結果

| | バックエンド | フロントエンド | 合計 |
| :--- | ---: | ---: | ---: |
| テスト数 | 473 | 42 | **515** |
| 成功 | 473 | 42 | **515** |
| パス率 | 100% | 100% | **100%** |
| カバレッジ | 96% | — | — |

## 備考

- すべてのテストは実装済みで、テストが通過することを確認済み
- バックエンドは正常系・異常系の両方を網羅的にカバー
- 外部依存（Firestore、Google Cloud API、Gemini API）はすべてモックを使用
- フロントエンドはUIコンポーネントの表示と動作をカバー
